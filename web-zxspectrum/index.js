!function(e){function t(t){for(var n,a,s=t[0],o=t[1],i=0,c=[];i<s.length;i++)a=s[i],Object.prototype.hasOwnProperty.call(r,a)&&r[a]&&c.push(r[a][0]),r[a]=0;for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n]);for(l&&l(t);c.length;)c.shift()()}var n={},r={0:0};var a={};var s={3:function(){return{"../src/js/utils":{now:function(){return n[0].exports.k()}},"./index_bg.js":{__wbindgen_string_new:function(e,t){return n[2].exports.ab(e,t)},__wbg_alert_9dcb7b3476401383:function(e,t){return n[2].exports.b(e,t)},__wbindgen_object_drop_ref:function(e){return n[2].exports.X(e)},__wbg_new_8303d5fc6648f8f3:function(){return n[2].exports.v()},__wbg_set_67c7de77e99efd31:function(e,t,r){return n[2].exports.L(e,t,r)},__wbindgen_number_new:function(e){return n[2].exports.W(e)},__wbg_ctrlKey_f080ec163dcc2703:function(e){return n[2].exports.l(e)},__wbg_shiftKey_d11f615955404512:function(e){return n[2].exports.O(e)},__wbg_code_c3b28f37b4149e68:function(e,t){return n[2].exports.e(e,t)},__wbg_getModifierState_b6cb98c792c66e40:function(e,t,r){return n[2].exports.q(e,t,r)},__wbg_preventDefault_93d06688748bfc14:function(e){return n[2].exports.C(e)},__wbg_value_e777d8ebaee40486:function(e){return n[2].exports.T(e)},__wbg_setvalue_b131e8da9633811c:function(e,t){return n[2].exports.N(e,t)},__wbg_gain_4df90433f6e80c75:function(e){return n[2].exports.p(e)},__wbg_duration_a146ee179820824a:function(e){return n[2].exports.o(e)},__wbg_copyToChannel_bd11b16314c06eac:function(e,t,r,a){return n[2].exports.g(e,t,r,a)},__wbg_connect_a4e3fd3dce194b2c:function(e,t){return n[2].exports.f(e,t)},__wbg_setbuffer_68371a3a4f02f6fd:function(e,t){return n[2].exports.M(e,t)},__wbg_start_3181340053431b4c:function(e,t,r,a){return n[2].exports.P(e,t,r,a)},__wbg_destination_647daf47bfcda8af:function(e){return n[2].exports.n(e)},__wbg_sampleRate_2cc9cd67bcfefcb6:function(e){return n[2].exports.J(e)},__wbg_currentTime_9790fc4a74b6d62f:function(e){return n[2].exports.m(e)},__wbg_state_5a434ba3efa1082c:function(e){return n[2].exports.Q(e)},__wbg_new_c759b32bc33d4dfa:function(){return n[2].exports.x()},__wbg_close_4d14821b14172f7b:function(e){return n[2].exports.d(e)},__wbg_suspend_3d1d7bc7f13bd2e5:function(e){return n[2].exports.S(e)},__wbg_createBuffer_f42f7a85c347fd2e:function(e,t,r,a){return n[2].exports.i(e,t,r,a)},__wbg_createBufferSource_ba46d5cecab7525f:function(e){return n[2].exports.h(e)},__wbg_createGain_76746a6a33b74c41:function(e){return n[2].exports.j(e)},__wbg_resume_777b6136e3bbedbe:function(e){return n[2].exports.I(e)},__wbg_newwithu8clampedarrayandsh_104cc36644cfc313:function(e,t,r,a){return n[2].exports.B(e,t,r,a)},__wbg_new_e13110f81ae347cf:function(){return n[2].exports.y()},__wbg_push_b46eeec52d2b03bb:function(e,t){return n[2].exports.D(e,t)},__wbg_reject_5d8c18a490c1b8b2:function(e){return n[2].exports.F(e)},__wbg_resolve_2529512c3bb73938:function(e){return n[2].exports.H(e)},__wbindgen_is_undefined:function(e){return n[2].exports.U(e)},__wbg_buffer_49131c283a06686f:function(e){return n[2].exports.c(e)},__wbg_newwithbyteoffsetandlength_17b60ac1a19c43e4:function(e,t,r){return n[2].exports.z(e,t,r)},__wbg_new_066196c5e92c30d6:function(e){return n[2].exports.u(e)},__wbg_newwithbyteoffsetandlength_c0f38401daad5a22:function(e,t,r){return n[2].exports.A(e,t,r)},__wbg_new_9b295d24cf1d706f:function(e){return n[2].exports.w(e)},__wbg_self_1c83eb4471d9eb9b:function(){return n[2].exports.K()},__wbg_static_accessor_MODULE_abf5ae284bffdf45:function(){return n[2].exports.R()},__wbg_require_5b2b5b594d809d9f:function(e,t,r){return n[2].exports.G(e,t,r)},__wbg_crypto_c12f14e810edcaa2:function(e){return n[2].exports.k(e)},__wbg_msCrypto_679be765111ba775:function(e){return n[2].exports.t(e)},__wbg_getRandomValues_05a60bf171bfc2be:function(e){return n[2].exports.r(e)},__wbg_getRandomValues_3ac1b33c90b52596:function(e,t,r){return n[2].exports.s(e,t,r)},__wbg_randomFillSync_6f956029658662ec:function(e,t,r){return n[2].exports.E(e,t,r)},__wbindgen_string_get:function(e,t){return n[2].exports.Z(e,t)},__wbindgen_throw:function(e,t){return n[2].exports.bb(e,t)},__wbindgen_rethrow:function(e){return n[2].exports.Y(e)},__wbindgen_memory:function(){return n[2].exports.V()}}}}};function o(t){if(n[t])return n[t].exports;var r=n[t]={i:t,l:!1,exports:{}};return e[t].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.e=function(e){var t=[],n=r[e];if(0!==n)if(n)t.push(n[2]);else{var i=new Promise((function(t,a){n=r[e]=[t,a]}));t.push(n[2]=i);var c,u=document.createElement("script");u.charset="utf-8",u.timeout=120,o.nc&&u.setAttribute("nonce",o.nc),u.src=function(e){return o.p+""+e+".index.js"}(e);var l=new Error;c=function(t){u.onerror=u.onload=null,clearTimeout(d);var n=r[e];if(0!==n){if(n){var a=t&&("load"===t.type?"missing":t.type),s=t&&t.target&&t.target.src;l.message="Loading chunk "+e+" failed.\n("+a+": "+s+")",l.name="ChunkLoadError",l.type=a,l.request=s,n[1](l)}r[e]=void 0}};var d=setTimeout((function(){c({type:"timeout",target:u})}),12e4);u.onerror=u.onload=c,document.head.appendChild(u)}return({1:[3]}[e]||[]).forEach((function(e){var n=a[e];if(n)t.push(n);else{var r,i=s[e](),c=fetch(o.p+""+{3:"5e1935c2c156a09674ed"}[e]+".module.wasm");if(i instanceof Promise&&"function"==typeof WebAssembly.compileStreaming)r=Promise.all([WebAssembly.compileStreaming(c),i]).then((function(e){return WebAssembly.instantiate(e[0],e[1])}));else if("function"==typeof WebAssembly.instantiateStreaming)r=WebAssembly.instantiateStreaming(c,i);else{r=c.then((function(e){return e.arrayBuffer()})).then((function(e){return WebAssembly.instantiate(e,i)}))}t.push(a[e]=r.then((function(t){return o.w[e]=(t.instance||t).exports})))}})),Promise.all(t)},o.m=e,o.c=n,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o.oe=function(e){throw console.error(e),e},o.w={};var i=window.webpackJsonp=window.webpackJsonp||[],c=i.push.bind(i);i.push=t,i=i.slice();for(var u=0;u<i.length;u++)t(i[u]);var l=c;o(o.s=1)}([function(e,t,n){"use strict";n.d(t,"e",(function(){return r})),n.d(t,"g",(function(){return a})),n.d(t,"h",(function(){return s})),n.d(t,"n",(function(){return i})),n.d(t,"m",(function(){return c})),n.d(t,"s",(function(){return u})),n.d(t,"a",(function(){return l})),n.d(t,"c",(function(){return d})),n.d(t,"b",(function(){return f})),n.d(t,"d",(function(){return p})),n.d(t,"l",(function(){return h})),n.d(t,"i",(function(){return m})),n.d(t,"p",(function(){return _})),n.d(t,"j",(function(){return g})),n.d(t,"r",(function(){return y})),n.d(t,"o",(function(){return v})),n.d(t,"q",(function(){return k})),n.d(t,"f",(function(){return x})),n.d(t,"k",(function(){return j}));class r{constructor(){this.bindings={}}bind(e,t,n,r){return"string"!=typeof t&&(r=n,n=t,t="change"),document.getElementById(e).addEventListener(t,t=>{t.preventDefault();try{n(t),"function"==typeof this.onchange&&this.onchange(e)}catch(e){alert(e)}},!1),this.bindings[e]=r,this}update(){for(let e in this.bindings){let t=this.bindings[e];if("function"==typeof t)t(document.getElementById(e))}return this}}function a(e){return e>=0?1+e/100:1/(1-e/100)}function s(e){return e>=1?100*(e-1):100*(1-1/e)}const o=/^\s*(0x[0-9a-f]+|\d+)\s*([,=:])\s*(0x[0-9a-f]+|\d+)\s*$/i;function i(e){var t=e.match(o);if(t){let e=parseInt(t[1]),n=parseInt(t[3]);if(isFinite(e)&&isFinite(n))switch(t[2]){case",":return[e,e+n];case":":return[e,n]}}}function c(e){var t=e.match(o);if(t){let e=parseInt(t[1]),n=parseInt(t[3]);if(isFinite(e)&&isFinite(n))switch(t[2]){case",":case"=":return[e,n]}}}function u(e,t){var n=e.toString(16);return t-=n.length,"0".repeat(t>=0?t:0)+n}function l(e){return document.getElementById(e)}function d(e,t,n){e.addEventListener(t,n,!1)}function f(e,t,n){e.removeEventListener(t,n,!1)}const p={UP:1,RIGHT:2,DOWN:4,LEFT:8},{abs:b}=Math;function h(e,t,n,r){var a=null;const{UP:s,RIGHT:o,DOWN:i,LEFT:c}=p;function u(e){e.preventDefault(),a=null}function l(e){var l=e.changedTouches;if(null!=a&&1===l.length&&l[0].identifier===a.id){let{screenX:d,screenY:f}=l[0],p=d-a.x,h=f-a.y,m=b(p),_=b(h);if(m>n||_>n){let n=0;m*=2,_*=2,-h>m?n=s:p>_?n=o:h>m?n=i:-p>_&&(n=c),u(e),0!=(n&t)&&r(n)}else e.preventDefault()}else u(e)}d(e,"touchstart",(function(e){var t=e.changedTouches;if(e.preventDefault(),1===t.length&&null==a){let e=t[0];a={id:e.identifier,x:e.screenX,y:e.screenY}}else u(e)})),d(e,"touchcancel",u),d(e,"touchmove",l),d(e,"touchend",(function(e){l(e),a=null}))}function m(){const e=document.createElement("a");return document.body.appendChild(e),e.style="display: none",function(t,n,r){var a=new Blob([t],{type:n}),s=URL.createObjectURL(a);e.href=s,e.download=r,e.click(),URL.revokeObjectURL(s)}}function _(e,t,n){n?e.attachDevice(t):e.detachDevice(t)}function g(e,t){return fetch(e).then(n=>{if(n.ok)return t?n.text():n.arrayBuffer().then(e=>new Uint8Array(e));throw"Error loading from: "+e})}const w=/#fresh(?:#|$)/;function y(e,t){const n=window.localStorage;var r=0;return function(a){var s=a.timeStamp;if(null!=n&&s>r+1e3){r=s;const a=t.cache,o=window.location.pathname,i="SPECTRUSTY:i"+o,c="SPECTRUSTY:v"+o;if(w.test(a))n.removeItem(i),n.removeItem(c);else{let t=e.toJSON();n.setItem(i,a),n.setItem(c,t)}}}}function v(e,t){const n=window.localStorage,r=t.cache,a=window.location.pathname,s="SPECTRUSTY:i"+a,o="SPECTRUSTY:v"+a;if(null!=n&&!w.test(r)&&r===n.getItem(s)){let t=n.getItem(o);if(null!=t)try{return e.parseJSON(t),!0}catch(e){console.error(e)}}return!1}function k(e){const{width:t,height:n}=e,r=e.getContext("2d"),a=t/8,s=n/8;for(let[e,o]of["#D80000","#D8D800","#00D800","#00D8D8"].entries())r.beginPath(),r.moveTo((4+e)*a,n),r.lineTo(t,(4+e)*s),r.lineTo(t,(5+e)*s),r.lineTo((5+e)*a,n),r.fillStyle=o,r.strokeStyle=o,r.fill(),r.stroke();r.font="48px sans-serif",r.textBaseline="middle",r.textAlign="end",r.fillStyle="#D8D8D8",r.fillText("S P E C T ",t/2,n/2),r.textAlign="start",r.fillStyle="#880000",r.fillText("R U S T Y",t/2,n/2)}function x(){var e=l("alert");try{if(void 0===window.WebAssembly)throw Error("required browser with WebAssembly support");if("function"!=typeof window.requestAnimationFrame)throw Error("required browser with requestAnimationFrame support");if("function"!=typeof window.fetch)throw Error("required browser with fetch support");if("function"!=typeof window.TextDecoder)throw Error("required browser with TextDecoder support");if("function"!=typeof window.ImageBitmap)throw Error("required browser with ImageBitmap support")}catch(e){throw"required browser with "===e.message.substr(0,22)&&(l("alert-feature").innerHTML="<strong>"+e.message.substr(22).split(" ",1)[0]+"</strong>"),e}e.parentElement.removeChild(e)}function j(){return performance.now()}},function(e,t,n){"use strict";n.r(t);var r=n(0);const a={m:"model",i:"interlace",b:"border",j:"joystick",k:"keyboard",t:"tapChunk"},s={tf:"fastTape",ti:"instantTape",ta:"audibleTape",km:"kempstonMouse"};class o{constructor(){const e=location.hash;this.options=i(e),this.tap=null,this.snap=null,this.cache=e}hashChanged(){const e=location.hash;if(e!=this.cache)return this.options=i(e),this.cache=e,this.options}mergeAll(e){var t=[];const n=this.options,r=n.ay||(n.ay={});null==n.model&&t.push("models"),null==n.interlace&&t.push("interlace"),null==n.border&&t.push("borders"),null==n.joystick&&t.push("joysticks"),null==n.fastTape&&t.push("fast-tape"),null==n.instantTape&&t.push("instant-tape"),null==n.audibleTape&&t.push("audible-tape"),null==n.kempstonMouse&&t.push("kempston-mouse"),null==r.melodik&&t.push("ay-melodik"),null==r.fuller&&t.push("ay-fuller-box"),null==r.amps&&t.push("ay-amps"),null==r.channels&&t.push("ay-channels"),t.forEach(t=>this.updateFrom(e,t)),this.updateLocation()}updateAll(e){["models","interlace","borders","joysticks","fast-tape","instant-tape","audible-tape","ay-amps","ay-channels"].forEach(t=>this.updateFrom(e,t)),this.updateLocation()}updateFrom(e,t){const n=this.options,r=n.ay||(n.ay={});switch(t){case"models":n.model=l(e.model),["ay-melodik","ay-fuller-box","kempston-mouse"].forEach(t=>this.updateFrom(e,t));case"keyboard-issue":n.keyboard=(a=e.keyboardIssue).startsWith("Issue")?l(a):"";break;case"interlace":n.interlace=e.interlace;break;case"borders":n.border=function(e){return d[e]||"6"}(e.borderSize);break;case"joysticks":n.joystick=function(e){return f[e]||""}(e.joystick);break;case"fast-tape":n.fastTape=e.fastTape;break;case"instant-tape":n.instantTape=e.instantTape;break;case"audible-tape":n.audibleTape=e.audibleTape;break;case"ay-melodik":r.melodik=e.hasDevice("Melodik");break;case"ay-fuller-box":r.fuller=e.hasDevice("Fuller Box");break;case"kempston-mouse":n.kempstonMouse=e.hasDevice("Kempston Mouse");break;case"ay-amps":r.amps=e.ayAmps.toLowerCase();break;case"ay-channels":r.channels=e.ayChannels;break;case"files":this.removeTap();break;case"reset-hard":case"reset-soft":case"reset-power":case"trigger-nmi":this.removeSnap();break;case"tap-eject":this.removeTap();case"tap-chunks":{let[t,r]=e.tapeProgress();t<0?delete n.tapChunk:n.tapChunk=""+t;break}default:return!1}var a;return!0}updateLocation(){const e=function(e){var t="";for(let n in a){let r=e[a[n]];r&&(t+=`#${n}=${r}`)}for(let n in s){let r=e[s[n]];null!=r&&(t+=`#${n}=${r?"1":"0"}`)}t+=function(e){var t=["amps","channels","melodik","fuller"].filter(t=>!!e[t]).map(t=>{let n=e[t];return"string"==typeof n?n:t}).join(",");return t?"#ay="+t:""}(e.ay||{});let n=e.tap;if(n)for(let e of n)t+="#tap="+e;let r=e.snap;r&&(t+=`#${r.type}=${r.url}`);return t}(this.options);this.cache=e,location.hash=e}applyTo(e){const{model:t,interlace:n,border:a,joystick:s,keyboard:o,fastTape:i,instantTape:c,audibleTape:l,kempstonMouse:d,ay:f,tapChunk:p}=this.options;t&&u(()=>e.selectModel(t)),u(()=>e.interlace=0|n),u(()=>e.selectBorderSize(a||"full")),u(()=>e.selectJoystick(function(e){switch(e.toLowerCase()){case"k":case"kempston":return 0;case"f":case"fuller":return 1;case"sr":case"sinclair right":return 2;case"sl":case"sinclair left":return 3;case"c":case"cursor":case"protek":case"agf":return 4;default:{let t=parseInt(e);return t>=0&&t<=4?t:-1}}}(s||""))),e.keyboardIssue.startsWith("Issue")&&u(()=>e.keyboardIssue="Issue "+(o||"3")),e.fastTape=null==i||i,e.instantTape=null==c||c,e.audibleTape=null==l||l,Object(r.p)(e,"Kempston Mouse",d);let{amps:b,melodik:h,fuller:m,channels:_}=f||{};Object(r.p)(e,"Melodik",h),Object(r.p)(e,"Fuller Box",m),u(()=>e.ayAmps=b||"Spec"),u(()=>e.ayChannels=(_||"ACB").toUpperCase()),null!=p&&u(()=>e.selectTapeChunk(p))}removeTap(){delete this.options.tap,this.tap=null}removeSnap(){delete this.options.snap,this.snap=null}modifiedTap(){const e=this.options.tap;var t=e!=this.tap;return this.tap=e||null,t}modifiedSnap(){var e=!0;const t=this.options.snap;return t?(this.snap&&(e=t.type!==this.snap.type||t.url!==this.snap.url),e&&(this.snap={type:t.type,url:t.url})):(e=!!this.snap,this.snap=null),e}}function i(e){var t,n={};for(let r of e.split("#")){let e=r.indexOf("="),o=r.substr(0,e).toLowerCase(),i=r.substr(e+1);switch(o){case"ay":n.ay=c(i.split(","));break;case"tap":n.tap||(n.tap=t=[]),t.push(i);break;case"sna":case"z80":case"json":n.snap={type:o,url:i};break;default:let e=a[o];e?n[e]=i:(e=s[o],e&&(n[e]=""!=i&&"0"!=i))}}return n}function c(e){var t={};for(let n of e)switch(n=n.toLowerCase()){case"fuse":case"spec":t.amps=n;break;case"melodik":case"fuller":t[n]=!0;break;case"mono":t.channels=n;default:/^[abc]{3}$/.test(n)&&(t.channels=n.toUpperCase())}return t}function u(e){try{e()}catch(e){alert(e)}}function l(e){return e.substr(e.lastIndexOf(" ")+1)}const d={full:"6",large:"5",medium:"4",small:"3",tiny:"2",minimal:"1",none:"0"};const f={Kempston:"k",Fuller:"f","Sinclair Right":"sr","Sinclair Left":"sl",Cursor:"c"};const p=[[35,27,19,11,3,4,12,20,28,36],[34,26,18,10,2,5,13,21,29,37],[33,25,17,9,1,6,14,22,30,38],[32,24,16,8,0,7,15,23,31,39]],b=p.reduce((e,t)=>e+t.length,0),h=new Array(b);p.forEach((e,t)=>e.forEach((e,n)=>{h[e]=function(e,t){var n,r,a=47;const s=new Path2D;switch(e){case 0:r=27,n=12+65*t;break;case 1:r=92,n=44+65*t;break;case 2:r=158,n=60+65*t;break;default:switch(r=223,t){case 0:n=12,a=63;break;case 9:n=614,a=78;break;default:n=94+65*(t-1)}}return s.rect(n,r,a,32),s}(t,n)}));class m{constructor(e,t){this.canvas=e,this.state=new Array(b).fill(!1),this.lastMouseKey=null,this.pendingTouches=new Map,e.width=704,e.height=281,this.ctx=e.getContext("2d",{alpha:!1,desynchronized:!0});const n=new Image(e.width,e.height);n.onload=()=>{e.width=n.naturalWidth,e.height=n.naturalHeight,this.keyboard=n,this.redraw()},n.src=t}bind(e){if("function"==typeof e){if("function"!=typeof this.onkey){const e=this.canvas;Object(r.c)(e,"mousedown",e=>_.call(this,e,!0)),Object(r.c)(e,"mouseup",e=>_.call(this,e,!1)),Object(r.c)(e,"mouseout",e=>_.call(this,e,!1)),Object(r.c)(e,"touchstart",e=>g.call(this,e)),Object(r.c)(e,"touchmove",e=>g.call(this,e)),Object(r.c)(e,"touchend",e=>w.call(this,e)),Object(r.c)(e,"touchcancel",e=>w.call(this,e))}this.onkey=e}}update(e){for(var t=this.state,n=e>>>0,r=0,a=32;;a=b){for(;r<a;++r)t[r]=!0&n,n>>>=1;if(r>=b)break;n=e/4294967296>>>0}return this}redraw(){const e=this.keyboard;if(!e)return;const t=this.state,n=this.ctx;n.globalAlpha=1,n.drawImage(e,0,0),n.globalAlpha=.5,n.fillStyle="blue";for(var r=0;r<b;++r)t[r]&&n.fill(h[r])}}function _(e,t){var n;const r=(e,t)=>{this.state[e]=t,this.onkey(e,t)};if(t?(null!=this.lastMouseKey&&(r(this.lastMouseKey,!1),this.lastMouseKey=null),n=y(e.offsetX,e.offsetY,this.canvas)):n=this.lastMouseKey,null==n)return;const a=32===n&&!this.state[31]||31===n&&!this.state[32];!t&&a||(t&&this.state[n]&&(t=!1),this.lastMouseKey=t&&!a?n:null,r(n,t),t||(32!==n&&this.state[32]&&r(32,!1),31!==n&&this.state[31]&&r(31,!1)),this.redraw())}function g(e){const t=this.canvas,n=e.changedTouches,r=this.pendingTouches;e.preventDefault();var a=!1;for(let e=0;e<n.length;++e){let s=n[e],o=s.identifier,i=y(s.clientX-t.offsetLeft,s.clientY-t.offsetTop,t),c=r.get(o);i!=c&&(null!=i?(r.set(o,i),this.state[i]=!0,this.onkey(i,!0)):r.delete(o),null!=c&&(this.state[c]=!1,this.onkey(c,!1)),a=!0)}a&&this.redraw()}function w(e){const t=e.changedTouches,n=this.pendingTouches;e.preventDefault();for(let e=0;e<t.length;++e){let r=t[e].identifier,a=n.get(r);null!=a&&(n.delete(r),this.state[a]=!1,this.onkey(a,!1))}this.redraw()}function y(e,t,n){const{width:r,height:a,clientWidth:s,clientHeight:o}=n,i=r/s,c=a/o;return i>c?(e*=i,t=t*i-(i*o-a)/2):(e=e*c-(c*s-r)/2,t*=c),function(e,t){if(t>0)if(t<74){if(e>=1&&e<651)return p[0][(e-1)/65|0]}else if(t<135){if(e>=35&&e<685)return p[1][(e-35)/65|0]}else if(t<203){if(e>=52&&e<702)return p[2][(e-52)/65|0]}else if(t<267&&e>0){if(e<85)return p[3][0];if(e<605)return p[3][1+((e-85)/65|0)];if(e<=700)return p[3][9]}}(e,t)}Object(r.f)(),Object(r.q)(Object(r.a)("main-screen")),$(()=>{$("[title]").tooltip()}),n.e(1).then(n.bind(null,5)).then(e=>{e.setPanicHook();const t=new o,n=new e.ZxSpectrumEmu(.11,t.options.model||"+2B"),a=new m(Object(r.a)("spectrum-keyboard"),"images/keyboard48.jpg"),s=Object(r.a)("main-screen"),i=Object(r.a)("main-container"),c=Object(r.a)("spectrum-container"),u=(Object(r.a)("controls"),Object(r.a)("tape-name")),l=Object(r.a)("tap-chunks"),d=Object(r.a)("tape-progress"),f=Object(r.a)("tap-play"),p=Object(r.a)("tap-record"),b=Object(r.a)("pause-resume"),h=Object(r.a)("files"),_=(Object(r.a)("speed-control"),Object(r.a)("speed-current")),g=Object(r.a)("intro-modal"),w=Object(r.i)(),y=Object(r.r)(n,t);var v=!1,k=new ImageData(1,1);const x=new r.e;function j(){$(g).modal({keyboard:!1})}x.onchange=e=>{t.updateFrom(n,e)&&t.updateLocation()},Object(r.c)(window,"hashchange",e=>{t.hashChanged()&&H(!1).then(()=>x.update())}),x.bind("main-screen","click",R).bind("menu-title","click",R).bind("menu-hover","mouseover",M).bind("pause-resume","click",K).bind("turbo",e=>n.turbo=e.target.checked,e=>e.checked=n.turbo).bind("sound-gain","input",e=>n.gain=e.target.value,e=>e.value=n.gain).bind("models",e=>{n.selectModel(e.target.value),x.update()},e=>e.value=n.model).bind("borders",e=>n.selectBorderSize(e.target.value),e=>e.value=n.borderSize).bind("interlace",e=>n.interlace=e.target.selectedIndex,e=>e.selectedIndex=n.interlace).bind("joysticks",e=>n.selectJoystick(e.target.selectedIndex-1),e=>e.value=n.joystick).bind("reset-hard","click",e=>n.reset(!0)).bind("reset-soft","click",e=>n.reset(!1)).bind("reset-power","click",e=>n.powerCycle()).bind("trigger-nmi","click",e=>n.triggerNmi()).bind("ay-fuller-box",N,Y).bind("ay-melodik",N,Y).bind("kempston-mouse",N,Y).bind("audible-tape",e=>n.audibleTape=e.target.checked,e=>e.checked=n.audibleTape).bind("fast-tape",e=>n.fastTape=e.target.checked,e=>e.checked=n.fastTape).bind("instant-tape",e=>n.instantTape=e.target.checked,e=>e.checked=n.instantTape).bind("files","input",e=>{!function e(r,a){if((a|=0)<r.length){let s=r.item(a),o=s.name,i=o.toLowerCase().substring(o.lastIndexOf(".")),c=new FileReader;c.onloadend=function(){var s=c.result;"string"!=typeof s&&(s=new Uint8Array(s));try{switch(i){case".tap":u.value=o,X(0==a?n.insertTape(s):n.appendTape(s)),setTimeout(()=>e(r,a+1),0);break;case".scr":n.showScr(s);break;case".sna":n.loadSna(s),u.value="";break;case".z80":n.loadZ80(s),u.value="";break;case".json":n.parseJSON(s),u.value="";break;default:alert("Unsupported file type.")}}catch(e){alert(e)}x.update(),t.updateAll(n)},".json"===i?c.readAsText(s):c.readAsArrayBuffer(s)}}(e.target.files),e.target.value=""}).bind("tap-play","click",e=>J(n.togglePlayTape())).bind("tap-record","click",e=>J(n.toggleRecordTape())).bind("tap-download","click",e=>function(){var e=n.tapeData();if(!e)return;w(e,"octet/stream",u.value||"new tape.tap")}()).bind("tap-chunks","input",e=>{n.selectTapeChunk(e.target.selectedIndex),G()},e=>{X(n.tapeInfo()),J(n.tapeStatus())}).bind("tap-eject","click",e=>{n.ejectTape(),h.value=u.value="",X(n.tapeInfo()),J(n.tapeStatus())}).bind("ay-amps",e=>n.ayAmps=e.target.value,e=>e.value=n.ayAmps).bind("ay-channels",e=>n.ayChannels=e.target.value,e=>e.value=n.ayChannels).bind("speed-reset","click",(function(){Z(0),x.update()})).bind("speed-control","input",e=>Z(e.target.value),e=>{var t=n.cpuRateFactor;e.value=Object(r.h)(t),_.value="x"+t.toFixed(2)}).bind("toggle-keyboard","click",B).bind("keyboard-issue",e=>n.keyboardIssue=e.target.value,e=>{e.value=n.keyboardIssue,e.disabled=!e.value}).bind("save-z80v3","click",e=>Q(3)).bind("save-z80v2","click",e=>Q(2)).bind("save-z80v1","click",e=>Q(1)).bind("save-sna","click",e=>{return t=n.saveSNA(),void w(t,"octet/stream","spectrusty.sna");var t}).bind("save-snapshot","click",e=>{return t=n.toJSON(),void w(t,"json","spectrusty.json");var t}).bind("poke-memory","click",e=>{var t=prompt("POKE");if(t)if(t=Object(r.m)(t)){let[e,r]=t;n.poke(e,r)}else alert("Please provide address and the value in a valid format.\nE.g.:\n0x4000, 0xff\n0x4000=0xff\n16384, 255\n16384=255")}).bind("peek-memory","click",e=>{var t=prompt("PEEK");if(t){let e=parseInt(t);if(isFinite(e)){let e=n.peek(t);alert("PEEK "+t+": "+e+" (0x"+e.toString(16)+")")}else alert("Please provide a single address in the range: [0, 65535] or [0x0, 0xFFFF]")}}).bind("dump-memory","click",e=>V("Dump memory range at:","octet/stream","memory","bin",(e,t)=>n.dump(e,t))).bind("disasm-memory","click",e=>V("Disassemble memory range at:","text/plain","z80asm","txt",(e,t)=>n.disassemble(e,t))),$(g).on("hide.bs.modal",e=>{v&&K()}).on("show.bs.modal",e=>{v||K()}),Object(r.c)(document,"keydown",e=>{if(!e.repeat)switch(e.code){case"F1":e.preventDefault(),j();break;case"F2":case"F3":case"F4":case"F5":case"F6":case"F7":case"F8":e.preventDefault(),B();break;case"F9":case"F10":case"F11":case"F12":break;case"Pause":K();break;case"Escape":i.classList.toggle("show-panel");break;default:n.updateStateFromKeyEvent(e,!0),a.update(n.keyboard).redraw()}}),Object(r.c)(document,"keyup",e=>{n.updateStateFromKeyEvent(e,!1),a.update(n.keyboard).redraw()}),a.bind((e,t)=>n.setKeyState(e,t)),Object(r.c)(s,"click",S);const T=I(!0),O=I(!1);function S(e){n.hasDevice("Kempston Mouse")&&s.requestPointerLock()}function E(e){n.moveMouse(e.movementX,e.movementY)}function I(e){return t=>n.updateMouseButton(t.button,e)}Object(r.c)(document,"pointerlockchange",e=>{const t=document.pointerLockElement===s,n=t?r.c:r.b,a=t?r.b:r.c;n(s,"mousemove",E),n(s,"mousedown",T),n(s,"mouseup",O),a(s,"click",S)}),Object(r.c)(window,"pagehide",y),Object(r.c)(window,"unload",y),Object(r.c)(window,"visibilitychange",e=>{document.hidden&&y(e)});const{LEFT:F,RIGHT:P,UP:C,DOWN:A}=r.d;function D(e){switch(e){case P:M();break;case F:R();break;case C:c.classList.add("show-keyboard");break;case A:c.classList.remove("show-keyboard")}}Object(r.l)(s,P|F|C|A,50,D),Object(r.l)(Object(r.a)("menu-title"),F,20,D),u.value="";const L=s.getContext("2d",{alpha:!1,desynchronized:!0});function M(){i.classList.add("show-panel")}function R(){i.classList.remove("show-panel")}function B(){c.classList.toggle("show-keyboard")}function K(){return v="Pause"==b.value,b.disabled=!0,(v?n.pauseAudio():n.resumeAudio()).then(()=>{b.value=v?"Resume":"Pause",b.disabled=!1})}function U(e){if(v)return Promise.resolve(!1);let t=n.runFramesWithAudio(e);if(null==t)return Promise.resolve(!1);{let{width:e,height:r,data:a}=n.renderVideo();if(e!==k.width||r!==k.height){let[t,a]=n.canvasSize;s.width=t,s.height=a,k=new ImageData(e,r)}return k.data.set(a),createImageBitmap(k).then(e=>(L.drawImage(e,0,0,s.width,s.height),e.close(),t))}}function z(){U(performance.now()).then(q)}function W(e){U(e).then(q)}function q(e){e&&x.update(),i.classList.contains("show-panel")&&p.disabled&&G(),n.turbo?setTimeout(z,0):requestAnimationFrame(W)}function N(e){Object(r.p)(n,e.target.name,e.target.checked)}function Y(e){e.checked=n.hasDevice(e.name)}function J(e){switch(e){case 0:f.value="Play",f.disabled=!1,p.value="Record",p.disabled=!1,l.disabled=!1;break;case 1:f.value="Pause",f.disabled=!1,p.value="Record",p.disabled=!0,l.disabled=!0;break;case 2:f.value="Play",f.disabled=!0,p.value="Stop",p.disabled=!1,l.disabled=!0}G()}function H(e){var a,s,o=Promise.resolve("fresh");if(e&&Object(r.o)(n,t))e=!1,o=Promise.resolve("continue");else if(t.modifiedSnap()){let i=t.snap;i&&(e=!1,o=(a=i.url,s=i.type,Object(r.j)(a,"json"===s).then(e=>{switch(s){case"sna":n.loadSna(e);break;case"z80":n.loadZ80(e);break;case"json":n.parseJSON(e);break;default:return}u.value="",t.mergeAll(n)}).catch(e=>alert(e))).then(()=>"run"))}if(t.modifiedTap()){let a=t.tap;o=o.then(s=>{return(o=a,Promise.allSettled((o||[]).map(e=>Object(r.j)(e,!1))).then(e=>{var t;for(let r of e)if("fulfilled"===r.status){let e=r.value;t=t?n.appendTape(e):n.insertTape(e)}else alert(r.reason);t||(n.ejectTape(),t=n.tapeInfo()),X(t),h.value=u.value="",J(n.tapeStatus())}).catch(e=>alert(e))).then(()=>(t.applyTo(n),a&&e&&(n.resetAndLoad(),s="run"),s));var o})}else o=o.then(e=>(t.applyTo(n),e));return o.catch(e=>alert(e))}function X(e){var t=0,n=l.options;for(let{info:r,size:a}of e){let e=n.item(t++);null==e&&(e=document.createElement("option"),l.appendChild(e)),e.value=a,e.text=r}n.length=t,G()}function G(){var[e,t]=n.tapeProgress();l.selectedIndex;l.selectedIndex=e;var r=l.selectedOptions.item(0);if(r){let e=0|r.value;d.value=e-t,d.max=e}else d.value=0,d.max=0}function Z(e){let t=Object(r.g)(e);_.value="x"+t.toFixed(2),n.setCpuRateFactor(t)}function V(e,t,n,a,s){var o=prompt(e);if(o)if(o=Object(r.n)(o)){let[e,i]=o;try{let o=s(e,i);w(o,t,`${n}-0x${Object(r.s)(65535&e,4)}-0x${Object(r.s)(65535&i,4)}.${a}`)}catch(e){alert(e)}}else alert("Please provide address range in a valid format.\nE.g.:\n0x4000:0x4100\n0x4000, 0x100\n16384:16640\n16384, 256")}function Q(e){var t=n.saveZ80(e);w(t,"octet/stream","spectrusty.z80")}L.imageSmoothingEnabled=!1,H(!0).then(e=>{"fresh"!==e&&"continue"!==e||M(),"fresh"!==e&&"run"!==e||K().then(j),q(!0)})}).catch(console.error)}]);